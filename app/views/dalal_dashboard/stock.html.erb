<% content_for :page_wrapper do %>
        <div id="page-wrapper">

            <div class="container-fluid">

                <!-- Page Heading -->
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">
                            Dalal Panel <small>Stock Market</small>
                        </h1>
                        <ol class="breadcrumb">
                            <li class="active">
                             <i class="fa fa-dashboard"></i> Dashboard
                            </li>
                        </ol>
                    </div>
                </div>
                <!-- /.row -->

                <div class="row">
                    <div class="col-lg-12">
                        <div class="alert alert-info alert-dismissable">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            <i class="fa fa-info-circle"></i>  <strong>Like Dalal Street?</strong> Like our FB page <a href="#">Dalal Street</a>
                        </div>
                    </div>
                </div>
                <!-- /.row -->

                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <div class="row">
                                    <div class="col-xs-3">
                                        <i class="fa fa-comments fa-5x"></i>
                                    </div>
                                    <div class="col-xs-9 text-right">
                                        <div class="huge">26</div>
                                        <div>New Comments!</div>
                                    </div>
                                </div>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">View Details</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="panel panel-green">
                            <div class="panel-heading">
                                <div class="row">
                                    <div class="col-xs-3">
                                       <i class="fa fa-money fa-5x"></i>
                                    </div>
                                    <div class="col-xs-9 text-right">
                                        <div class="huge"><%=current_user.cash%></div>
                                        <div>Cash</div>
                                    </div>
                                </div>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">View Details</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="panel panel-yellow">
                            <div class="panel-heading">
                                <div class="row">
                                    <div class="col-xs-3">
                                        <i class="fa fa-tasks fa-5x"></i>
                                    </div>
                                    <div class="col-xs-9 text-right">
                                        <div class="huge"><%=@price_of_tot_stock%></div>
                                        <div>Stock</div>
                                    </div>
                                </div>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">View Details</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="panel panel-red">
                            <div class="panel-heading">
                                <div class="row">
                                    <div class="col-xs-3">
                                        <i class="fa fa-support fa-5x"></i>
                                    </div>
                                    <div class="col-xs-9 text-right">
                                        <div class="huge">13</div>
                                        <div>Support Tickets!</div>
                                    </div>
                                </div>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">View Details</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- /.row -->

                <div class="row">
                 <div class="col-lg-12">  
                    <div id="ajax_notice">
                    </div>
                    <% if flash[:notice] %>
                    <div class="notice"><%= flash[:notice] %></div>
                    <% end %>
                    <% if flash[:error] %>
                    <div class="error"><%= flash[:error] %></div>
                    <% end %>
                  </div>
                  <div class="col-lg-8">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-money fa-fw"></i> Stocks </h3>
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">                            
                                  <table class="table table-bordered table-hover table-striped" data-uri="<%= request.host %>:<%= request.port %>/websocket">
                                        <thead>
                                            <tr>
                                                <th>Stock</th>
                                                <th>DayLow</th>
                                                <th>DayHigh</th>
                                                <th>Current (USD)</th>
                                                <th>StockInMarket</th>
                                                <th>StockInExchange</th>
                                                <th>TradeStock</th>
                                                <th>Trade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="render_tbody">
                                         <%= render partial:"dalal_dashboard/stock_partial",locals: { stocks: @stocks }%>  
                                        </tbody>
                                    </table>
                                </div>

                                <div class="text-right">
                                    <a href="#">View All Transactions <i class="fa fa-arrow-circle-right"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    
                    <div class="col-lg-4">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-clock-o fa-fw"></i> Notification Panel</h3>
                            </div>
                            <div class="panel-body">
                                <div class="list-group" data-uri="<%= request.host %>:<%= request.port %>/websocket">
                                <%= render partial:"dalal_dashboard/notification_partial",locals: { notifications_list: @notifications_list }%> 
                                </div>
                                <div class="text-right">
                                    <a href="#">View All Activity <i class="fa fa-arrow-circle-right"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.row -->

            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- /#page-wrapper -->
<% end %>


<% content_for :script do %>

 <script type="text/javascript">

    var swapper = function(swap_stock_trade){
     var coin_field_id = "stocktrade_"+swap_stock_trade.split('_')[1];
     document.getElementById(coin_field_id).value = document.getElementById(swap_stock_trade).value;
    };

    var isNumber= function(evt) {
        evt = (evt) ? evt : window.event;
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    };

         var connection = function(){var data = {connected : true}; return data;};

         var dispatcher = new WebSocketRails($('.table').data('uri'), true);

         dispatcher.on_open = function(){
            console.log('Connection has been established');
         };

         dispatcher.on_close = function(){
            console.log('Connection has been closed');
         };
         
         //function not completed
         var bind_check = 0;
        //remember to protect this variable later
         var binder = function(event){switch(event){
           
           case 'notification_update' : dispatcher.bind();

           case 'stock_ajax_handler'  : dispatcher.bind();

         }};

         var getnotifications = function(){

                var sent = {
                  receive: 'true'
                }

                 var success = function(response) {
                  console.log("Wow it worked: "+response.message);
                  dispatcher.unbind('notification_update');
                  };

                 var failure = function(response) {
                   console.log("That just totally failed: "+response.message);
                  };

                 dispatcher.bind('notification_update', getnotifications);
                 
                 dispatcher.trigger('notification_update', sent, success, failure); 
                
                 function getnotifications(notice) {
                       
                       console.log(notice);
                       console.log(notice.notice[0]);

                        for(var i = 0; i < 10; i++) {
                            var obj = notice.notice[i];
                            var notify = notify+'<a href="#" class="list-group-item"><span class="badge">'+notice.notice[i].updated_at+'</span> <i class="fa fa-fw fa-check"></i> '+notice.notice[i].notification+'</a>';
                        }

                      $(".list-group").empty().append(notify);
                      $( "#ajax_notice" ).empty().append("<p>"+notice.notice[0].notification+"</p>");

                    }
                 
    };
         
         var getvalues = function(value){  
         
                 var valuenum = value.split('_')[1];
                 var data = {identity: valuenum,value: document.getElementById(value).value};

                 var success = function(response) {
                    console.log("Wow it worked: "+response.message);
                  };

                 var failure = function(response) {
                    console.log("That just totally failed: "+response.message);
                  };

                 var gettable = function (get_value) {
                      console.log(get_value.sent_data.current_user);
                      console.log(get_value.sent_data.stock_update);

                      for(var i = 0; i < 15; i++) {
                            var obj = get_value.sent_data.stock_update[i];

                            var fill_table = fill_table+'<tr><td>'+obj.stockname+'</td><td>'+obj.daylow+'</td><td>'+obj.dayhigh+'</td><td>'+obj.currentprice+'</td><td>'+obj.stocksinmarket+'</td><td>'+obj.stocksinexchange+'</td><td><input id="'+obj.current_user+'_'+obj.id+'" type="text" onkeypress="return isNumber(event)" onchange="swapper(this.id);" style="width:75px;" maxlength="2"></input></td><td><input id="stocktrade_'+obj.id+'" type="hidden" name="stocktrade_'+obj.id+'" value=""></input> <input id="identity" type="hidden" value="stocktrade_'+obj.id+'" name="identity"></input><input type="button" value="Trade" name="Trade" onclick="getvalues(\'stocktrade_'+obj.id+'\');"></input></td></tr>'; 
                        }

                     $("#render_tbody").empty().append(fill_table);
                     getnotifications();
                
                  };

                if(!bind_check)
                    bind_check = dispatcher.bind('stock_ajax_handler', gettable);

                    dispatcher.trigger('stock_ajax_handler', data, success, failure); 
               
    };

    var channel = function(){
                // var channel = dispatcher.subscribe('<%=current_user.id%>');
                // channel.trigger('notification_update',sent,success,failure);
                // channel.bind('notification_update', function(data) {
                // console.log('channel event received: ' + data);});
                // channel.unbind('notification_update');
    };

    // $(".trade1").submit(function(){  
    //     var data = $(this).serialize();
    //     $.ajax({
    //         headers: {'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')},
    //         type: "POST",
    //         beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
    //         url: $(this).attr('action'),
    //         data: data,
    //         dataType: "json",
    //         cashe: false,
    //         success: function(data){console.log(data); return_result_div(data);},
    //         error  : function(){console.log("Error.Did not receive data"); return_result_div("Error.Did not receive data");}
    //       });
    //     return false; 
    // });

  //////// IMPORTANT  ...................   Please check for websocket support  /////////////////   
// var support = "MozWebSocket" in window ? 'MozWebSocket' : ("WebSocket" in window ? 'WebSocket' : null);
// if (support == null) {
//     alert("Your browser doesn't support Websockets.");
//     return;   
//}

// for(var i = 0; i < json.length; i++) {
//     var obj = json[i];

//     console.log(obj.id);
// }

</script>

<% end %>    